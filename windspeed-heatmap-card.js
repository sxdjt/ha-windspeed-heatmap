/* Last modified: 30-Jan-2026 23:04 */
const e=[{value:0,color:"rgba(187, 222, 251, 1)"},{value:1,color:"rgba(144, 202, 249, 1)"},{value:4,color:"rgba(100, 181, 246, 1)"},{value:8,color:"rgba(66, 165, 245, 1)"},{value:13,color:"rgba(30, 136, 229, 1)"},{value:19,color:"rgba(192, 202, 81, 1)"},{value:25,color:"rgba(225, 213, 60, 1)"},{value:32,color:"rgba(255, 213, 79, 1)"},{value:39,color:"rgba(255, 183, 77, 1)"},{value:47,color:"rgba(239, 108, 0, 1)"},{value:55,color:"rgba(244, 81, 30, 1)"},{value:64,color:"rgba(229, 57, 53, 1)"},{value:73,color:"rgba(183, 28, 28, 1)"}],t=[{value:0,color:"rgba(187, 222, 251, 1)"},{value:.3,color:"rgba(144, 202, 249, 1)"},{value:1.6,color:"rgba(100, 181, 246, 1)"},{value:3.4,color:"rgba(66, 165, 245, 1)"},{value:5.5,color:"rgba(30, 136, 229, 1)"},{value:8,color:"rgba(192, 202, 81, 1)"},{value:10.8,color:"rgba(225, 213, 60, 1)"},{value:13.9,color:"rgba(255, 213, 79, 1)"},{value:17.2,color:"rgba(255, 183, 77, 1)"},{value:20.8,color:"rgba(239, 108, 0, 1)"},{value:24.5,color:"rgba(244, 81, 30, 1)"},{value:28.5,color:"rgba(229, 57, 53, 1)"},{value:32.7,color:"rgba(183, 28, 28, 1)"}],n=[{value:0,color:"rgba(187, 222, 251, 1)"},{value:1,color:"rgba(144, 202, 249, 1)"},{value:6,color:"rgba(100, 181, 246, 1)"},{value:12,color:"rgba(66, 165, 245, 1)"},{value:20,color:"rgba(30, 136, 229, 1)"},{value:29,color:"rgba(192, 202, 81, 1)"},{value:39,color:"rgba(225, 213, 60, 1)"},{value:50,color:"rgba(255, 213, 79, 1)"},{value:62,color:"rgba(255, 183, 77, 1)"},{value:75,color:"rgba(239, 108, 0, 1)"},{value:89,color:"rgba(244, 81, 30, 1)"},{value:103,color:"rgba(229, 57, 53, 1)"},{value:118,color:"rgba(183, 28, 28, 1)"}],o=[{value:0,color:"rgba(187, 222, 251, 1)"},{value:1,color:"rgba(144, 202, 249, 1)"},{value:4,color:"rgba(100, 181, 246, 1)"},{value:7,color:"rgba(66, 165, 245, 1)"},{value:11,color:"rgba(30, 136, 229, 1)"},{value:17,color:"rgba(192, 202, 81, 1)"},{value:22,color:"rgba(225, 213, 60, 1)"},{value:28,color:"rgba(255, 213, 79, 1)"},{value:34,color:"rgba(255, 183, 77, 1)"},{value:41,color:"rgba(239, 108, 0, 1)"},{value:48,color:"rgba(244, 81, 30, 1)"},{value:56,color:"rgba(229, 57, 53, 1)"},{value:64,color:"rgba(183, 28, 28, 1)"}];function i(i){if(!i)return e;const r=i.toLowerCase().trim();return"m/s"===r||"mps"===r?t:"km/h"===r||"kph"===r||"kmh"===r?n:"kn"===r||"kt"===r||"kts"===r||"knot"===r||"knots"===r?o:e}function r(e){if(e.startsWith("rgba(")){const t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(t)return{r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10)}}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return{r:parseInt(t[1],10),g:parseInt(t[2],10),b:parseInt(t[3],10)}}const t=e.replace("#","");return 6===t.length?{r:parseInt(t.substr(0,2),16),g:parseInt(t.substr(2,2),16),b:parseInt(t.substr(4,2),16)}:null}function a(e){const t=e.r/255,n=e.g/255,o=e.b/255,i=Math.max(t,n,o),r=Math.min(t,n,o),a=(i+r)/2;if(i===r)return{h:0,s:0,l:a};const s=i-r,l=a>.5?s/(2-i-r):s/(i+r);let c;switch(i){case t:c=60*((n-o)/s+(n<o?6:0));break;case n:c=60*((o-t)/s+2);break;case o:c=60*((t-n)/s+4)}return{h:c,s:l,l:a}}function s(e,t,n){const o=a(e),i=a(t);let r;const s=i.h-o.h;r=Math.abs(s)>180?s>0?o.h+(s-360)*n:o.h+(s+360)*n:o.h+s*n,r<0&&(r+=360),r>=360&&(r-=360);const l=function(e){const{h:t,s:n,l:o}=e,i=(1-Math.abs(2*o-1))*n,r=i*(1-Math.abs(t/60%2-1)),a=o-i/2;let s=0,l=0,c=0;return[s,l,c]=t<60?[i,r,0]:t<120?[r,i,0]:t<180?[0,i,r]:t<240?[0,r,i]:t<300?[r,0,i]:[i,0,r],{r:255*(s+a),g:255*(l+a),b:255*(c+a)}}({h:r,s:o.s+(i.s-o.s)*n,l:o.l+(i.l-o.l)*n});return`rgb(${Math.round(l.r)}, ${Math.round(l.g)}, ${Math.round(l.b)})`}function l(e){let t=e.r/255,n=e.g/255,o=e.b/255;t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92;const i=(.4124564*t+.3575761*n+.1804375*o)/.95047,r=.2126729*t+.7151522*n+.072175*o,a=(.0193339*t+.119192*n+.9503041*o)/1.08883,s=i>.008856?Math.pow(i,1/3):7.787*i+16/116,l=r>.008856?Math.pow(r,1/3):7.787*r+16/116;return{L:116*l-16,a:500*(s-l),b:200*(l-(a>.008856?Math.pow(a,1/3):7.787*a+16/116))}}function c(e,t,n){const o=l(e),i=l(t),r=function(e){const t=(e.L+16)/116,n=e.a/500+t,o=t-e.b/200,i=.95047*(Math.pow(n,3)>.008856?Math.pow(n,3):(n-16/116)/7.787),r=Math.pow(t,3)>.008856?Math.pow(t,3):(t-16/116)/7.787,a=1.08883*(Math.pow(o,3)>.008856?Math.pow(o,3):(o-16/116)/7.787);let s=3.2404542*i+-1.5371385*r+-.4985314*a,l=-.969266*i+1.8760108*r+.041556*a,c=.0556434*i+-.2040259*r+1.0572252*a;return s=s>.0031308?1.055*Math.pow(s,1/2.4)-.055:12.92*s,l=l>.0031308?1.055*Math.pow(l,1/2.4)-.055:12.92*l,c=c>.0031308?1.055*Math.pow(c,1/2.4)-.055:12.92*c,{r:Math.max(0,Math.min(255,255*s)),g:Math.max(0,Math.min(255,255*l)),b:Math.max(0,Math.min(255,255*c))}}({L:o.L+(i.L-o.L)*n,a:o.a+(i.a-o.a)*n,b:o.b+(i.b-o.b)*n});return`rgb(${Math.round(r.r)}, ${Math.round(r.g)}, ${Math.round(r.b)})`}function d(e,t,n,o="hsl"){const i=r(e),a=r(t);if(!i||!a)return e;switch(o){case"rgb":return function(e,t,n){return`rgb(${Math.round(e.r+(t.r-e.r)*n)}, ${Math.round(e.g+(t.g-e.g)*n)}, ${Math.round(e.b+(t.b-e.b)*n)})`}(i,a,n);case"gamma":return function(e,t,n,o=2.2){const i=255*Math.pow(Math.pow(e.r/255,o)*(1-n)+Math.pow(t.r/255,o)*n,1/o),r=255*Math.pow(Math.pow(e.g/255,o)*(1-n)+Math.pow(t.g/255,o)*n,1/o),a=255*Math.pow(Math.pow(e.b/255,o)*(1-n)+Math.pow(t.b/255,o)*n,1/o);return`rgb(${Math.round(i)}, ${Math.round(r)}, ${Math.round(a)})`}(i,a,n);case"hsl":default:return s(i,a,n);case"lab":return c(i,a,n)}}function h(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function p(e,t="24"){if("24"===t)return String(e).padStart(2,"0");return`${0===e?12:e>12?e-12:e}${e<12?"a":"p"}`}function g(e){return["N","NE","E","SE","S","SW","W","NW"][Math.round(e/45)%8]}function u(e,t){if(null==e)return"";switch(t){case"arrow":return function(e){const t=(e+180)%360;return["↑","↗","→","↘","↓","↙","←","↖"][Math.round(t/45)%8]}(e);case"cardinal":return g(e);case"degrees":return`${Math.round(e)}deg`;default:return""}}function f(e,t){return null==e||""===e?t:"number"==typeof e?`${e}px`:String(e)}function _(e){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function m(e,t){return Math.floor(e/t)*t}class v extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._config={},this._hass=null,this._historyData=null,this._processedData=null,this._lastFetch=0,this._viewOffset=0,this._isLoading=!1,this._error=null,this._interval=null,this.shadowRoot.appendChild(function(){const e=document.createElement("style");return e.textContent="\n    /* Main container */\n    ha-card {\n      display: block;\n      padding: 0;\n      overflow: hidden;\n    }\n\n    /* Card header with title and navigation */\n    .card-header {\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      padding: 16px;\n      border-bottom: 1px solid var(--divider-color);\n      flex-wrap: wrap;\n      gap: 8px;\n    }\n\n    .title {\n      font-size: 20px;\n      font-weight: 500;\n      color: var(--primary-text-color);\n    }\n\n    /* Navigation controls */\n    .nav-controls {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n    }\n\n    .nav-btn {\n      background: var(--primary-color);\n      color: var(--text-primary-color, white);\n      border: none;\n      border-radius: 4px;\n      width: 32px;\n      height: 32px;\n      font-size: 18px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: opacity 0.2s ease;\n    }\n\n    .nav-btn:hover:not(:disabled) {\n      opacity: 0.8;\n    }\n\n    .nav-btn:disabled {\n      opacity: 0.3;\n      cursor: not-allowed;\n    }\n\n    .nav-btn:focus {\n      outline: 2px solid var(--primary-color);\n      outline-offset: 2px;\n    }\n\n    .nav-btn-current {\n      background: var(--primary-color);\n      color: var(--text-primary-color, white);\n      border: none;\n      border-radius: 4px;\n      padding: 6px 12px;\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: opacity 0.2s ease;\n    }\n\n    .nav-btn-current:hover {\n      opacity: 0.8;\n    }\n\n    .nav-btn-current:focus {\n      outline: 2px solid var(--primary-color);\n      outline-offset: 2px;\n    }\n\n    .nav-btn-current.hidden {\n      visibility: hidden;\n      pointer-events: none;\n    }\n\n    .date-range {\n      font-size: 14px;\n      color: var(--secondary-text-color);\n      min-width: 120px;\n      text-align: center;\n    }\n\n    /* Heatmap grid container */\n    .heatmap-grid {\n      padding: 16px;\n    }\n\n    .month-header {\n      text-align: center;\n      font-size: 16px;\n      font-weight: 500;\n      color: var(--primary-text-color);\n      margin-bottom: 12px;\n    }\n\n    /* Grid wrapper with time labels and data grid */\n    .grid-wrapper {\n      display: grid;\n      grid-template-columns: auto 1fr;\n      gap: 8px;\n      align-items: start;\n    }\n\n    /* Time labels column */\n    .time-labels {\n      display: flex;\n      flex-direction: column;\n      gap: var(--cell-gap, 2px);\n      padding-top: 28px;  /* Align with data grid (after date headers) */\n    }\n\n    .time-label {\n      height: var(--cell-height, 36px);\n      display: flex;\n      align-items: center;\n      justify-content: flex-end;\n      padding-right: 8px;\n      font-size: var(--cell-font-size, 11px);\n      color: var(--secondary-text-color);\n      font-weight: 500;\n    }\n\n    /* Data grid container */\n    .data-grid-container {\n      display: flex;\n      flex-direction: column;\n      gap: 4px;\n    }\n\n    /* Date headers row */\n    .date-headers {\n      display: grid;\n      grid-template-columns: repeat(var(--days-count, 7), 1fr);\n      gap: 2px;\n      margin-bottom: 4px;\n    }\n\n    .date-header {\n      text-align: center;\n      font-weight: bold;\n      font-size: 12px;\n      color: var(--primary-text-color);\n      padding: 4px;\n    }\n\n    /* Data cells grid */\n    .data-grid {\n      display: grid;\n      grid-template-columns: repeat(var(--days-count, 7), var(--cell-width, 1fr));\n      grid-auto-rows: var(--cell-height, 36px);\n      gap: var(--cell-gap, 2px);\n    }\n\n    /* Individual cells */\n    .cell {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      border-radius: var(--cell-border-radius, 4px);\n      cursor: pointer;\n      transition: transform 0.1s ease, box-shadow 0.1s ease;\n      position: relative;\n      font-size: var(--cell-font-size, 11px);\n      padding: var(--cell-padding, 2px);\n      box-sizing: border-box;\n    }\n\n    .cell:hover:not(.no-data) {\n      transform: scale(1.08);\n      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n      z-index: 10;\n    }\n\n    .cell:focus {\n      outline: 2px solid var(--primary-color);\n      outline-offset: 2px;\n    }\n\n    .cell.no-data {\n      background-color: var(--disabled-color, #f0f0f0);\n      cursor: default;\n      opacity: 0.4;\n    }\n\n    .cell.no-data:hover {\n      transform: none;\n      box-shadow: none;\n    }\n\n    .speed {\n      font-weight: bold;\n      line-height: 1.1;\n    }\n\n    .direction {\n      font-size: 10px;\n      line-height: 1;\n      margin-top: 2px;\n    }\n\n    /* Footer with statistics */\n    .footer {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n      padding: 12px 16px;\n      border-top: 1px solid var(--divider-color);\n      background: var(--card-background-color);\n      font-size: 13px;\n      color: var(--secondary-text-color);\n    }\n\n    .footer-stats {\n      display: flex;\n      justify-content: space-around;\n      align-items: center;\n    }\n\n    .footer-stats span {\n      font-weight: 500;\n    }\n\n    .entity-name {\n      text-align: center;\n      font-size: 11px;\n      color: var(--secondary-text-color);\n      opacity: 0.8;\n    }\n\n    /* Loading state */\n    .loading {\n      text-align: center;\n      padding: 32px;\n      color: var(--secondary-text-color);\n    }\n\n    .loading-spinner {\n      display: inline-block;\n      width: 24px;\n      height: 24px;\n      border: 3px solid var(--divider-color);\n      border-top-color: var(--primary-color);\n      border-radius: 50%;\n      animation: spin 1s linear infinite;\n    }\n\n    @keyframes spin {\n      to { transform: rotate(360deg); }\n    }\n\n    /* Error message */\n    .error-message {\n      display: flex;\n      align-items: flex-start;\n      gap: 12px;\n      padding: 16px;\n      margin: 16px;\n      background: rgba(244, 67, 54, 0.1);\n      color: var(--error-color, #f44336);\n      border-radius: 4px;\n      border-left: 4px solid var(--error-color, #f44336);\n    }\n\n    .error-icon {\n      font-size: 20px;\n      flex-shrink: 0;\n    }\n\n    .error-text {\n      flex: 1;\n    }\n\n    .error-details {\n      font-size: 11px;\n      margin-top: 4px;\n      opacity: 0.8;\n    }\n\n    /* Tooltip */\n    .tooltip {\n      position: absolute;\n      z-index: 1000;\n      background: var(--card-background-color, white);\n      border: 1px solid var(--divider-color);\n      border-radius: 4px;\n      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);\n      padding: 8px 12px;\n      font-size: 12px;\n      pointer-events: none;\n      max-width: 250px;\n      line-height: 1.4;\n    }\n\n    .tooltip div {\n      margin: 2px 0;\n    }\n\n    .tooltip strong {\n      color: var(--primary-text-color);\n    }\n\n    /* Legend bar */\n    .legend {\n      padding: 8px 16px 12px;\n      border-top: 1px solid var(--divider-color);\n    }\n\n    .legend-bar {\n      height: 12px;\n      border-radius: 3px;\n      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);\n    }\n\n    .legend-labels {\n      display: flex;\n      justify-content: space-between;\n      margin-top: 4px;\n      font-size: 9px;\n      color: var(--secondary-text-color);\n    }\n\n    .legend-labels span {\n      flex: 1;\n      text-align: center;\n    }\n\n    .legend-labels span:first-child {\n      text-align: left;\n    }\n\n    .legend-labels span:last-child {\n      text-align: right;\n    }\n\n    /* Responsive adjustments */\n    @media (max-width: 600px) {\n      .data-grid {\n        grid-auto-rows: calc(var(--cell-height, 36px) * 0.83);\n      }\n\n      .time-label {\n        height: calc(var(--cell-height, 36px) * 0.83);\n        font-size: calc(var(--cell-font-size, 11px) * 0.91);\n      }\n\n      .cell {\n        font-size: calc(var(--cell-font-size, 11px) * 0.91);\n      }\n\n      .direction {\n        display: none;\n      }\n\n      .date-header {\n        font-size: 11px;\n      }\n    }\n\n    @media (max-width: 400px) {\n      .card-header {\n        flex-direction: column;\n        align-items: stretch;\n      }\n\n      .nav-controls {\n        justify-content: center;\n      }\n    }\n\n    /* Accessibility: High contrast mode support */\n    @media (prefers-contrast: high) {\n      .cell:not(.no-data) {\n        border: 1px solid currentColor;\n      }\n    }\n\n    /* Accessibility: Reduced motion support */\n    @media (prefers-reduced-motion: reduce) {\n      .cell,\n      .nav-btn,\n      .loading-spinner {\n        transition: none;\n        animation: none;\n      }\n    }\n  ",e}()),this._content=document.createElement("ha-card"),this.shadowRoot.appendChild(this._content),this._content.addEventListener("click",this._handleClick.bind(this)),this._responseCache=new Map}setConfig(e){if(!e.entity)throw new Error("'entity' is required (wind speed sensor)");const t=[1,2,3,4,6,8,12,24];if(e.time_interval&&!t.includes(e.time_interval))throw new Error(`time_interval must be one of: ${t.join(", ")}`);if(e.days&&(e.days<1||e.days>30))throw new Error("days must be between 1 and 30");const n=["rgb","gamma","hsl","lab"];if(e.color_interpolation&&!n.includes(e.color_interpolation))throw new Error(`color_interpolation must be one of: ${n.join(", ")}`);if(void 0!==e.cell_height){const t="number"==typeof e.cell_height?e.cell_height:parseFloat(e.cell_height);if(isNaN(t)||t<10||t>200)throw new Error("cell_height must be between 10 and 200 pixels")}if(void 0!==e.cell_padding){const t="number"==typeof e.cell_padding?e.cell_padding:parseFloat(e.cell_padding);if(isNaN(t)||t<0||t>20)throw new Error("cell_padding must be between 0 and 20 pixels")}if(void 0!==e.cell_gap){const t="number"==typeof e.cell_gap?e.cell_gap:parseFloat(e.cell_gap);if(isNaN(t)||t<0||t>20)throw new Error("cell_gap must be between 0 and 20 pixels")}if(void 0!==e.cell_font_size){const t="number"==typeof e.cell_font_size?e.cell_font_size:parseFloat(e.cell_font_size);if(isNaN(t)||t<6||t>24)throw new Error("cell_font_size must be between 6 and 24 pixels")}if(void 0!==e.cell_width&&"string"!=typeof e.cell_width){const t=parseFloat(e.cell_width);if(isNaN(t)||t<10||t>500)throw new Error("cell_width as number must be between 10 and 500 pixels")}const o=e.color_thresholds&&e.color_thresholds.length>0;this._config={entity:e.entity,direction_entity:e.direction_entity||null,title:e.title||"Wind Speed History",days:e.days||7,time_interval:e.time_interval||2,time_format:e.time_format||"24",unit:e.unit||null,_hasCustomThresholds:o,_thresholdsInitialized:!!e.unit,color_thresholds:o?e.color_thresholds:i(e.unit).slice(),show_direction:!1!==e.show_direction,direction_format:e.direction_format||"arrow",refresh_interval:e.refresh_interval||300,click_action:e.click_action||"more-info",show_entity_name:e.show_entity_name||!1,cell_height:void 0!==e.cell_height?e.cell_height:36,cell_width:void 0!==e.cell_width?e.cell_width:"1fr",cell_padding:void 0!==e.cell_padding?e.cell_padding:2,cell_gap:void 0!==e.cell_gap?e.cell_gap:2,cell_font_size:void 0!==e.cell_font_size?e.cell_font_size:11,compact:e.compact||!1,rounded_corners:!1!==e.rounded_corners,show_legend:e.show_legend||!1,interpolate_colors:e.interpolate_colors||!1,color_interpolation:e.color_interpolation||"hsl"},this._config.color_thresholds=[...this._config.color_thresholds].sort((e,t)=>e.value-t.value),this._hass&&this._clearAndSetInterval()}static getConfigElement(){return document.createElement("windspeed-heatmap-card-editor")}static getStubConfig(e){const t=Object.keys(e.states).filter(t=>{if(!t.startsWith("sensor."))return!1;const n=e.states[t],o=n?.attributes?.device_class,i=n?.attributes?.unit_of_measurement?.toLowerCase()||"";return"wind_speed"===o||i.includes("mph")||i.includes("km/h")||i.includes("m/s")||i.includes("knot")||i.includes("kn")||i.includes("kt")});let n=null;if(t.length>0){const o=e.states[t[0]];n=o?.attributes?.unit_of_measurement}return{entity:t.length>0?t[0]:"",title:"Wind Speed History",days:7,time_interval:2,color_thresholds:i(n).slice()}}set hass(e){if(this._hass=e,this._config&&this.isConnected){if(!this._config._hasCustomThresholds&&!this._config._thresholdsInitialized){const e=this._getUnit();e&&(this._config.color_thresholds=i(e).slice(),this._config._thresholdsInitialized=!0,console.log(`Windspeed Heatmap: Auto-selected ${e} thresholds`))}0===this._viewOffset&&this._isDataStale()&&this._fetchHistoryData()}}getCardSize(){const e=this._processedData?this._processedData.rows.length:12,t=this._getEffectiveSizing(),n=parseFloat(t.cellHeight)||36;return Math.ceil((e*n+100)/50)}connectedCallback(){this._config&&this._hass&&this._clearAndSetInterval()}disconnectedCallback(){this._interval&&(clearInterval(this._interval),this._interval=null)}_clearAndSetInterval(){this._interval&&(clearInterval(this._interval),this._interval=null),this._fetchHistoryData();const e=1e3*this._config.refresh_interval;this._interval=setInterval(()=>{0===this._viewOffset&&this._fetchHistoryData()},e)}_isDataStale(){if(!this._historyData||!this._lastFetch)return!0;return Date.now()-this._lastFetch>1e3*this._config.refresh_interval}async fetchWithCache(e,t=3e4,n=3e5){const o=Date.now(),i=`${e}_offset${this._viewOffset}`,r=this._responseCache.get(i);if(r&&r.expiry>o)return console.log("Windspeed Heatmap: Using cached data for:",i),r.data;const a=this._hass.callApi("GET",e),s=await Promise.race([a,new Promise((e,n)=>setTimeout(()=>n(new Error(`Request timeout after ${t}ms`)),t))]);return this._responseCache.set(i,{data:s,expiry:o+n}),s}async _fetchHistoryData(){if(this._isLoading)console.log("Windspeed Heatmap: Already loading, skipping duplicate fetch");else{this._isLoading=!0,this._error=null,this._render(),console.log("Windspeed Heatmap: Starting data fetch...");try{const e=new Date;let t;if(0===this._viewOffset){const n=e.getHours(),o=this._config.time_interval,i=Math.floor(n/o)*o;t=new Date(e),t.setHours(i,0,0,0)}else t=new Date(e),t.setDate(t.getDate()+this._viewOffset),t.setHours(23,59,59,999);const n=new Date(t);n.setDate(n.getDate()-this._config.days+1),n.setHours(0,0,0,0),console.log(`Windspeed Heatmap: Fetching from ${n.toLocaleString()} to ${t.toLocaleString()}`),console.log(`Windspeed Heatmap: Current time: ${e.toLocaleString()}, Last complete interval: ${t.toLocaleString()}`);const o=n.toISOString(),i=t.toISOString();console.log(`Windspeed Heatmap: API times - Start: ${o}, End: ${i}`);const r=`history/period/${o}?filter_entity_id=${this._config.entity}&end_time=${i}&minimal_response&no_attributes`,a=[this._hass.callApi("GET",r)];if(this._config.direction_entity&&this._config.show_direction){const e=`history/period/${o}?filter_entity_id=${this._config.direction_entity}&end_time=${i}&minimal_response&no_attributes`;a.push(this._hass.callApi("GET",e))}const s=(e,t=3e4)=>Promise.race([e,new Promise((e,n)=>setTimeout(()=>n(new Error("Request timeout after 30 seconds")),t))]),l=Date.now(),c=await s(Promise.all(a)),d=((Date.now()-l)/1e3).toFixed(1);console.log(`Windspeed Heatmap: Received ${c[0]?.[0]?.length||0} speed points, ${c[1]?.[0]?.length||0} direction points in ${d}s`),this._historyData={speed:c[0]?.[0]||[],direction:c[1]&&c[1][0]||[],startTime:n,endTime:t},this._lastFetch=Date.now();const h=Date.now();this._processData();const p=((Date.now()-h)/1e3).toFixed(2);console.log(`Windspeed Heatmap: Processed data in ${p}s`),this._isLoading=!1,console.log("Windspeed Heatmap: Starting render..."),this._render(),console.log("Windspeed Heatmap: Render complete")}catch(e){console.error("Windspeed Heatmap: Fetch error:",e),this._isLoading=!1,this._error={message:"Failed to fetch wind speed history",details:e.message},this._render()}}}_processData(){if(!this._historyData)return void(this._processedData=null);const{speed:e,direction:t,startTime:n}=this._historyData,o=this._config.time_interval,i=24/o,r={};e.forEach(e=>{const t=new Date(e.last_changed||e.last_updated),n=`${_(t)}_${m(t.getHours(),o)}`;r[n]||(r[n]={maxSpeed:null,directions:[]});const i=parseFloat(e.state);isNaN(i)||(null===r[n].maxSpeed||i>r[n].maxSpeed)&&(r[n].maxSpeed=i)}),t&&t.length>0&&t.forEach(e=>{const t=new Date(e.last_changed||e.last_updated),n=`${_(t)}_${m(t.getHours(),o)}`;if(r[n]){const t=parseFloat(e.state);isNaN(t)||r[n].directions.push(t)}}),Object.keys(r).forEach(e=>{const t=r[e];t.avgDirection=t.directions.length>0?function(e){if(0===e.length)return null;let t=0,n=0;e.forEach(e=>{const o=e*Math.PI/180;t+=Math.sin(o),n+=Math.cos(o)});let o=180*Math.atan2(t/e.length,n/e.length)/Math.PI;return o<0&&(o+=360),Math.round(o)}(t.directions):null});const a=[];for(let e=0;e<this._config.days;e++){const t=new Date(n);t.setDate(t.getDate()+e),a.push(t)}const s=[];let l=[];for(let e=0;e<i;e++){const t=e*o,n={hour:t,label:p(t,this._config.time_format),cells:a.map(e=>{const n=_(e),o=r[`${n}_${t}`],i={date:e,speed:o?.maxSpeed??null,direction:o?.avgDirection??null,hasData:o&&null!==o.maxSpeed};return null!==i.speed&&l.push(i.speed),i})};s.push(n)}const c={min:l.length>0?Math.min(...l):0,max:l.length>0?Math.max(...l):0,avg:l.length>0?l.reduce((e,t)=>e+t,0)/l.length:0};this._processedData={rows:s,dates:a,stats:c}}_render(){if(this._config&&this._hass&&(this._content.innerHTML=`\n      <div class="card-header">\n        <span class="title">${h(this._config.title)}</span>\n        ${this._renderNavControls()}\n      </div>\n\n      ${this._error?this._renderError():""}\n      ${this._isLoading?this._renderLoading():""}\n      ${this._processedData&&!this._error?this._renderGrid():""}\n      ${this._processedData&&!this._error?this._renderFooter():""}\n      ${this._processedData&&!this._error&&this._config.show_legend?this._renderLegend():""}\n    `,this._processedData)){this._content.style.setProperty("--days-count",this._config.days);const e=this._getEffectiveSizing();this._content.style.setProperty("--cell-height",e.cellHeight),this._content.style.setProperty("--cell-width",e.cellWidth),this._content.style.setProperty("--cell-padding",e.cellPadding),this._content.style.setProperty("--cell-gap",e.cellGap),this._content.style.setProperty("--cell-font-size",e.cellFontSize),this._content.style.setProperty("--cell-border-radius",this._config.rounded_corners?"4px":"0")}}_renderNavControls(){const e=this._viewOffset<0,t=this._viewOffset<0;return`\n      <div class="nav-controls">\n        <button class="nav-btn" data-direction="back" aria-label="Previous period">&#8592;</button>\n        <span class="date-range">${this._getDateRangeLabel()}</span>\n        <button class="nav-btn" data-direction="forward"\n                ${e?"":"disabled"}\n                aria-label="Next period">&#8594;</button>\n        <button class="nav-btn-current ${t?"":"hidden"}"\n                data-direction="current"\n                aria-label="Jump to current"\n                ${t?"":'aria-hidden="true"'}>Current</button>\n      </div>\n    `}_getDateRangeLabel(){if(!this._processedData)return"";const{dates:e}=this._processedData,t=e[0],n=e[e.length-1],o={month:"short",day:"numeric"};return`${t.toLocaleDateString(void 0,o)} - ${n.toLocaleDateString(void 0,o)}`}_renderLoading(){return'\n      <div class="loading">\n        <div class="loading-spinner"></div>\n        <div style="margin-top: 8px;">Loading wind data...</div>\n      </div>\n    '}_renderError(){return`\n      <div class="error-message">\n        <div class="error-icon">!</div>\n        <div class="error-text">\n          <strong>${h(this._error.message)}</strong>\n          <div class="error-details">${h(this._error.details)}</div>\n        </div>\n      </div>\n    `}_renderGrid(){const{rows:e,dates:t}=this._processedData,n=t[0].toLocaleDateString(void 0,{month:"long",year:"numeric"}),o=t.map(e=>`<div class="date-header">${e.getDate()}</div>`).join("");return`\n      <div class="heatmap-grid">\n        <div class="month-header">${n}</div>\n        <div class="grid-wrapper">\n          <div class="time-labels">\n            ${e.map(e=>`<div class="time-label">${e.label}</div>`).join("")}\n          </div>\n          <div class="data-grid-container">\n            <div class="date-headers">\n              ${o}\n            </div>\n            <div class="data-grid">\n              ${e.map(e=>e.cells.map(e=>this._renderCell(e)).join("")).join("")}\n            </div>\n          </div>\n        </div>\n      </div>\n    `}_renderCell(e){if(!e.hasData)return'<div class="cell no-data"><span class="speed">-</span></div>';const t=function(e,t,n=!1,o="hsl"){if(null==e)return"var(--disabled-color, #f0f0f0)";if(!n){let n=t[0].color;for(let o=0;o<t.length&&e>=t[o].value;o++)n=t[o].color;return n}if(e<=t[0].value)return t[0].color;if(e>=t[t.length-1].value)return t[t.length-1].color;for(let n=0;n<t.length-1;n++)if(e>=t[n].value&&e<t[n+1].value){const i=(e-t[n].value)/(t[n+1].value-t[n].value);return d(t[n].color,t[n+1].color,i,o)}return t[t.length-1].color}(e.speed,this._config.color_thresholds,this._config.interpolate_colors,this._config.color_interpolation),n=function(e){if(e.startsWith("var("))return"var(--primary-text-color)";if(e.startsWith("rgba(")){const t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(t)return(.299*parseInt(t[1],10)+.587*parseInt(t[2],10)+.114*parseInt(t[3],10))/255>.5?"#000000":"#ffffff"}if(e.startsWith("rgb(")){const t=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(t)return(.299*parseInt(t[1],10)+.587*parseInt(t[2],10)+.114*parseInt(t[3],10))/255>.5?"#000000":"#ffffff"}const t=e.replace("#","");if(6===t.length)return(.299*parseInt(t.substr(0,2),16)+.587*parseInt(t.substr(2,2),16)+.114*parseInt(t.substr(4,2),16))/255>.5?"#000000":"#ffffff";return"var(--primary-text-color)"}(t),o=this._config.show_direction?u(e.direction,this._config.direction_format):"";return`\n      <div class="cell"\n           style="background-color: ${t}; color: ${n}"\n           data-speed="${e.speed}"\n           data-direction="${e.direction||""}"\n           data-date="${e.date.toISOString()}"\n           tabindex="0"\n           role="button"\n           aria-label="Wind speed ${e.speed.toFixed(1)}">\n        <span class="speed">${e.speed.toFixed(1)}</span>\n        ${o?`<span class="direction">${o}</span>`:""}\n      </div>\n    `}_renderFooter(){const{stats:e}=this._processedData,t=this._getUnit();let n="";if(this._config.show_entity_name){const e=this._hass?.states[this._config.entity];n=`<div class="entity-name">${h(e?.attributes?.friendly_name||this._config.entity)}</div>`}return`\n      <div class="footer">\n        <div class="footer-stats">\n          <span>Min: ${e.min.toFixed(1)} ${t}</span>\n          <span>Max: ${e.max.toFixed(1)} ${t}</span>\n          <span>Avg: ${e.avg.toFixed(1)} ${t}</span>\n        </div>\n        ${n}\n      </div>\n    `}_renderLegend(){const e=this._config.color_thresholds,t=e[e.length-1].value,n=e.map(e=>{const n=Math.min(e.value/Math.max(t,75)*100,100);return`${e.color} ${n.toFixed(0)}%`}).join(", "),o=[0,3,6,9,e.length-1].filter(t=>t<e.length).map(t=>e[t].value).filter((e,t,n)=>n.indexOf(e)===t);return`\n      <div class="legend">\n        <div class="legend-bar" style="background: linear-gradient(to right, ${n});"></div>\n        <div class="legend-labels">\n          ${o.map((e,t)=>`<span>${e}${t===o.length-1?"+":""}</span>`).join("")}\n        </div>\n      </div>\n    `}_getUnit(){if(this._config.unit)return this._config.unit;const e=this._hass?.states[this._config.entity];return e?.attributes?.unit_of_measurement?e.attributes.unit_of_measurement:"mph"}_handleClick(e){const t=e.target.closest(".nav-btn, .nav-btn-current");if(t&&!t.disabled){const e=t.dataset.direction;return void this._handleNavigation(e)}const n=e.target.closest(".cell");n&&!n.classList.contains("no-data")&&this._handleCellClick(n)}_handleNavigation(e){"back"===e?this._viewOffset-=this._config.days:"forward"===e?(this._viewOffset+=this._config.days,this._viewOffset>0&&(this._viewOffset=0)):"current"===e&&(this._viewOffset=0),this._fetchHistoryData()}_handleCellClick(e){switch(this._config.click_action){case"more-info":this._showMoreInfo();break;case"tooltip":this._showTooltip(e)}}_showMoreInfo(){this.dispatchEvent(new CustomEvent("hass-more-info",{bubbles:!0,composed:!0,detail:{entityId:this._config.entity}}))}_showTooltip(e){const t=parseFloat(e.dataset.speed),n=e.dataset.direction,o=new Date(e.dataset.date),i=this.shadowRoot.querySelector(".tooltip");i&&i.remove();const r=document.createElement("div");r.className="tooltip";const a=o.toLocaleString(void 0,{month:"short",day:"numeric"}),s=this._getUnit(),l=n?` ${g(n)} (${Math.round(n)}deg)`:"";r.innerHTML=`\n      <div><strong>${a}</strong></div>\n      <div>Speed: ${t.toFixed(1)} ${s}${l}</div>\n    `;const c=e.getBoundingClientRect(),d=this._content.getBoundingClientRect();r.style.left=c.left-d.left+c.width/2+"px",r.style.top=c.bottom-d.top+4+"px",r.style.transform="translateX(-50%)",this._content.appendChild(r),setTimeout(()=>{r.parentElement&&r.remove()},3e3)}_getEffectiveSizing(){return this._config.compact?{cellHeight:"24px",cellWidth:"1fr",cellPadding:"1px",cellGap:"1px",cellFontSize:"9px"}:{cellHeight:f(this._config.cell_height,"36px"),cellWidth:f(this._config.cell_width,"1fr"),cellPadding:f(this._config.cell_padding,"2px"),cellGap:f(this._config.cell_gap,"2px"),cellFontSize:f(this._config.cell_font_size,"11px")}}}class b extends HTMLElement{constructor(){super(),this._config={},this._hass=null,this.content=null}set hass(e){this._hass=e,this.content||this._buildEditor()}async setConfig(e){this._config={...e||{}};const t=await window.loadCardHelpers();if(!customElements.get("ha-entity-picker")){const e=await t.createCardElement({type:"entities",entities:[]});await e.constructor.getConfigElement()}this._config={entity:"",direction_entity:"",title:"Wind Speed History",days:7,time_interval:2,time_format:"24",unit:"",show_direction:!0,direction_format:"arrow",refresh_interval:300,click_action:"more-info",show_entity_name:!1,cell_height:36,cell_width:"1fr",cell_padding:2,cell_gap:2,cell_font_size:11,compact:!1,rounded_corners:!0,show_legend:!1,interpolate_colors:!1,color_interpolation:"hsl",color_thresholds:[],...this._config},this.content&&this._updateValues()}getConfig(){return{...this._config}}_buildEditor(){this.content=document.createElement("div"),this.content.style.display="grid",this.content.style.gridGap="8px",this.content.style.padding="8px",this.appendChild(this.content),this.container_threshold={},this.fields={};[{type:"entity",key:"entity",label:"Wind Speed Entity",required:!0},{type:"entity",key:"direction_entity",label:"Wind Direction Entity"},{type:"text",key:"title",label:"Title"},{type:"number",key:"days",label:"Days",min:1,max:30},{type:"number",key:"time_interval",label:"Time Interval (hours)",min:1,max:24},{type:"select",key:"time_format",label:"Time Format",options:{24:"24h",12:"12h"}},{type:"select",key:"unit",label:"Unit",options:{"":"Auto-detect",mph:"mph","km/h":"km/h","m/s":"m/s",kn:"knots"}},{type:"switch",key:"show_direction",label:"Show Direction"},{type:"select",key:"direction_format",label:"Direction Format",options:{arrow:"Arrow",cardinal:"Cardinal",degrees:"Degrees"}},{type:"number",key:"refresh_interval",label:"Refresh Interval (s)",min:10,max:3600},{type:"select",key:"click_action",label:"Click Action",options:{none:"None","more-info":"More Info",tooltip:"Tooltip"}},{type:"switch",key:"show_entity_name",label:"Show Entity Name"},{type:"switch",key:"show_legend",label:"Show Legend"},{type:"number",key:"cell_height",label:"Cell Height",min:10,max:200},{type:"text",key:"cell_width",label:"Cell Width (px or fr)"},{type:"number",key:"cell_padding",label:"Cell Padding",min:0,max:50},{type:"number",key:"cell_gap",label:"Cell Gap",min:0,max:50},{type:"number",key:"cell_font_size",label:"Cell Font Size",min:6,max:32},{type:"switch",key:"compact",label:"Compact Mode"},{type:"switch",key:"rounded_corners",label:"Rounded Corners"},{type:"switch",key:"interpolate_colors",label:"Interpolate Colors"},{type:"select",key:"color_interpolation",label:"Color Interpolation",options:{rgb:"RGB",gamma:"Gamma RGB",hsl:"HSL",lab:"LAB"}},{type:"thresholds",key:"color_thresholds",label:"Colors"}].forEach(e=>this._createField(e)),this._updateValues()}_createThresholdEditor(){const e=(e,t)=>{const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",n.style.gap="8px";const o=document.createElement("ha-textfield");o.type="number",o.value=e.value,o.addEventListener("change",e=>{e.stopPropagation();const n=[...this._config.color_thresholds],o={...this._config.color_thresholds[t]};o.value=Number(e.target.value),n[t]=o,this._onFieldChange("color_thresholds",n),this._refreshThresholdEditor()});const i=document.createElement("input");i.type="color",i.value=function(e){if(e.startsWith("#"))return e;const t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);if(t)return`#${parseInt(t[1],10).toString(16).padStart(2,"0")}${parseInt(t[2],10).toString(16).padStart(2,"0")}${parseInt(t[3],10).toString(16).padStart(2,"0")}`;return"#ffffff"}(e.color),i.addEventListener("change",e=>{e.stopPropagation();const n=[...this._config.color_thresholds],o={...this._config.color_thresholds[t]};o.color=e.target.value,n[t]=o,this._onFieldChange("color_thresholds",n),this._refreshThresholdEditor()});const r=document.createElement("button");r.textContent="X",r.style.cursor="pointer",r.addEventListener("click",e=>{e.stopPropagation();const n=[...this._config.color_thresholds];n.splice(t,1),this._onFieldChange("color_thresholds",n),this._refreshThresholdEditor()}),n.appendChild(o),n.appendChild(i),n.appendChild(r),this.container_threshold.appendChild(n)};this._config.color_thresholds||(this._config.color_thresholds=[]),this._config.color_thresholds.forEach((t,n)=>e(t,n))}_refreshThresholdEditor(){for(;this.container_threshold.firstChild;)this.container_threshold.removeChild(this.container_threshold.firstChild);this._createThresholdEditor()}_updateValues(){if(this._config)for(const e in this.fields){const t=this.fields[e].input;"checkbox"===this.fields[e].type||"switch"===this.fields[e].type?t.checked=!!this._config[e]:"thresholds"===this.fields[e].type?this._refreshThresholdEditor():t.value=void 0!==this._config[e]?this._config[e]:""}}_createField({type:e,key:t,label:n,min:o,max:i,options:r,required:a}){const s=document.createElement("div");let l;if(s.style.display="flex",s.style.flexDirection="column",s.style.marginBottom="8px","switch"===e){s.style.flexDirection="row",s.style.alignItems="center",s.style.gap="8px",l=document.createElement("ha-switch");const e=document.createElement("label");e.textContent=n,s.appendChild(l),s.appendChild(e),l.addEventListener("change",e=>{e.stopPropagation(),this._onFieldChange(t,l.checked)})}else if("thresholds"===e){const e=document.createElement("label");e.textContent=n,s.appendChild(e);const o=document.createElement("div");o.style.display="grid",o.style.gridGap="8px",s.appendChild(o),this.container_threshold=o;const i=document.createElement("button");i.textContent="Add Threshold",i.style.marginTop="8px",i.addEventListener("click",e=>{e.stopPropagation();const n=[...this._config.color_thresholds];n.push({value:0,color:"#ffffff"}),this._onFieldChange(t,n)}),s.appendChild(i)}else{const c=document.createElement("label");if(c.textContent=n,s.appendChild(c),"entity"===e)l=document.createElement("ha-entity-picker"),l.setAttribute("allow-custom-entity",""),l.hass=this._hass,l.addEventListener("value-changed",e=>{e.stopPropagation(),this._onFieldChange(t,e.detail.value)});else if("number"===e||"text"===e)l=document.createElement("ha-textfield"),l.type=e,void 0!==o&&(l.min=o),void 0!==i&&(l.max=i),a&&(l.required=!0),l.addEventListener("change",n=>{n.stopPropagation();const o="number"===e?Number(l.value):l.value;this._onFieldChange(t,o)});else if("select"===e){l=document.createElement("ha-select");for(const e in r){const t=document.createElement("mwc-list-item");t.value=e,t.innerText=r[e],l.appendChild(t)}l.addEventListener("selected",e=>{e.stopPropagation(),this._onFieldChange(t,e.target.value)}),l.addEventListener("closed",e=>{e.stopPropagation()})}s.appendChild(l)}this.fields[t]={},this.fields[t].input=l,this.fields[t].type=e,this.content.appendChild(s)}_onFieldChange(e,t){const n={...this._config,[e]:t};this._config=n,this.dispatchEvent(new CustomEvent("config-changed",{detail:{config:n},bubbles:!0,composed:!0}))}disconnectedCallback(){this.fields={},this.container_threshold=null}}customElements.define("windspeed-heatmap-card-editor",b),customElements.define("windspeed-heatmap-card",v),window.customCards=window.customCards||[],window.customCards.push({type:"windspeed-heatmap-card",name:"Windspeed Heatmap Card",description:"Display wind speed history as a color-coded heatmap using Beaufort scale colors"}),console.info("%c WINDSPEED-HEATMAP-CARD %c v0.4.0 ","color: lightblue; font-weight: bold; background: black","color: white; font-weight: bold; background: dimgray");
//# sourceMappingURL=windspeed-heatmap-card.js.map
